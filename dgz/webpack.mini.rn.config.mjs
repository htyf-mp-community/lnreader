import path from 'path'
import { fileURLToPath } from 'node:url'
import { dirname } from 'node:path'
import TerserPlugin from 'terser-webpack-plugin'
import * as Repack from '@callstack/repack'
import fse from 'fs-extra';
import webpack from 'webpack'
import md5 from 'md5'
import dayjs from 'dayjs'
import crypto from 'crypto'
import { rimrafSync } from 'rimraf'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(fileURLToPath(import.meta.url))

const webcrypto = crypto.webcrypto;
const uuid = webcrypto.randomUUID();
console.log(__dirname)
const projectConfig = fse.readJsonSync(path.join(__dirname, '../project.dgz.json'))
const pkgPath = path.join(__dirname, '../package.json')
const entryPath = path.join(__dirname, '../index.js')
const exposesPath = path.join(__dirname, '../src/index.tsx');
const node_modulesPath = path.join(__dirname, '../node_modules')

const pkg = fse.readJSONSync(pkgPath)

let appSharedObj = fse.readJSONSync(path.join(node_modulesPath, '@hongtangyun/react-native-mini-apps-engines/shared.json'))
let sharedObj = {}

for (const key in appSharedObj) {
  const p = appSharedObj[key]
  if (
    key === '@wuba/react-native-echarts' ||
    key === 'taro-charts' ||
    key === 'redux-saga' ||
    key === 'react-redux' ||
    key === '@reduxjs/toolkit' || 
    key === 'immer'
  ) {
    
  } else {
    sharedObj[key] = {
      /** 是否运行为单例 */
      singleton: true,
      /** 是否不拆包 === host 必须为true */
      eager: true,
      requiredVersion: p.replace(/\^/gi, '')
    }
  }
}

export default env => {
  const {
    dgzenv = '',
    mode = 'development',
    context = Repack.getDirname(import.meta.url),
    entry = entryPath,
    platform = process.env.PLATFORM,
    minimize = mode === 'production',
    devServer = undefined,
    bundleFilename = undefined,
    sourceMapFilename = undefined,
    assetsPath = undefined,
    reactNativePath = new URL(`${node_modulesPath}/react-native`, import.meta.url)
      .pathname,
  } = env
  const dirname = Repack.getDirname(import.meta.url)

  const appid = `${projectConfig.appid}${dgzenv ? `__${dgzenv}__` : ''}`
  const version = `${pkg.version}${dgzenv ? `.${Date.now()}` : ''}`

  console.log('bundleFilename', bundleFilename)
  if (!platform) {
    throw new Error('Missing platform')
  }
  process.env.BABEL_ENV = mode
  const appName = `root_${appid}_${mode === 'production' ? md5(appid+uuid) : 'test'}`;
  const outpath = path.join(dirname, 'build', `v${version}`, platform)
  const outpaths = path.join(outpath, '../../', `v${version}`, 'outputs', platform)
  
  rimrafSync(outpath)
  rimrafSync(outpaths)
  console.log('appName: ', appName)
  console.log('outpath: ', outpath)
  console.log('outpaths: ', outpaths)
  const appConfigPath = path.join(outpath, '../../', 'outputs', 'app.json')
  fse.emptyDirSync(outpath)
  fse.emptyDirSync(outpaths)
  fse.emptyDirSync(path.join(appConfigPath, '..'))
  fse.writeJSONSync(appConfigPath, 
    {
      "type": "app",
      "name": projectConfig.projectname,
      "appid": appid,
      "version": version,
      "appUrlConfig": projectConfig.appUrlConfig,
      "zipUrl": projectConfig.zipUrl,
  }, {
    spaces: 2
  })
  const _options = Repack.getResolveOptions(platform);
  _options.extensions.unshift('.react-native.js', '.react-native.ts', '.react-native.tsx', '.rn.js', '.rn.ts')
  console.log(_options)
  return {
    mode,
    devtool: false,
    context,
    entry: [
      ...Repack.getInitializationEntries(reactNativePath, {
        hmr: devServer && devServer.hmr,
      }),
      entry,
    ],
    resolve: {
      ..._options,
      alias: {
        '@babel/runtime': path.join(node_modulesPath, `@babel/runtime`),
        axios$: path.join(node_modulesPath, 'axios/dist/browser/axios.cjs'),
        cheerio$: path.join(node_modulesPath, 'cheerio/lib/index.js'),
        realm$: path.join(node_modulesPath, 'realm/index.react-native.js'),
        // immer$: path.join(node_modulesPath, 'immer/dist/index.js'),
        '@sentry/react-native': path.join(node_modulesPath, `@sentry/react-native/dist/js/index.js`),
        'native-base': path.join(node_modulesPath, `native-base/lib/commonjs/index.js`),
        '@react-stately/combobox': path.join(node_modulesPath, `@react-stately/combobox/src/index.ts`),
        'mobx-react-lite': path.join(node_modulesPath, `mobx-react-lite/es/index.js`),
        'mobx': path.join(node_modulesPath, `mobx/dist/mobx.esm.js`),
      },
    },
    
    output: {
      clean: true,
      path: outpath,
      filename: 'index.bundle',
      chunkFilename: `[name].chunk.bundle`,
      // chunkFilename: `${appName}.[name].chunk.bundle`,
      publicPath: Repack.getPublicPath({ platform, devServer }),
    },
    optimization: {
      minimize,
      minimizer: [
        new TerserPlugin({
          test: /\.(js)?bundle(\?.*)?$/i,
          extractComments: false,
          terserOptions: {
            format: {
              comments: false,
            },
          },
        }),
      ],
      chunkIds: 'named',
      moduleIds: 'named',
    },
    module: {
      rules: [
        {
          test: /\.(js|jsx|ts|tsx|cjs)$/, 
          include: [
            /node_modules(.*[/\\])+react/,
            /node_modules(.*[/\\])+@react-native/,
            /node_modules(.*[/\\])+@react-navigation/,
            /node_modules(.*[/\\])+@react-native-community/,
            /node_modules(.*[/\\])+@expo/,
            /node_modules(.*[/\\])+pretty-format/,
            /node_modules(.*[/\\])+metro/,
            /node_modules(.*[/\\])+abort-controller/,
            /node_modules(.*[/\\])+@callstack\/repack/,
            /** 第三方模块 */
            /node_modules(.*[/\\])+@shopify\/flash-list/,
            /node_modules(.*[/\\])+mobx/,
            /node_modules(.*[/\\])+mobx-react-lite/,
            /node_modules(.*[/\\])+react-i18next/,
            /node_modules(.*[/\\])+i18next/,
            /node_modules(.*[/\\])+@gorhom\/bottom-sheet/,
            /node_modules(.*[/\\])+@gorhom\/portal/,
            /node_modules(.*[/\\])+react-native-progress/,
            /node_modules(.*[/\\])+trtc-react-native/,
            /node_modules(.*[/\\])+native-base/,
            /node_modules(.*[/\\])+@native-html\/transient-render-engine/,
            /node_modules(.*[/\\])+@react-native-render-html/,
            /node_modules(.*[/\\])+@native-html\/css-processor/,
            /node_modules(.*[/\\])+@react-stately\/combobox/,
            /node_modules(.*[/\\])+simplex-noise/,
            /node_modules(.*[/\\])+@dr.pogodin\/js-utils/,
            /node_modules(.*[/\\])+lru-cache/,
            /node_modules(.*[/\\])+react-native-paper/,
            /node_modules(.*[/\\])+expo/,
            /node_modules(.*[/\\])+@sentry/,
            /node_modules(.*[/\\])+@hongtangyun/,
            /node_modules(.*[/\\])+@tarojs/,
            /node_modules(.*[/\\])+ffmpeg-kit-react-native/,
            /node_modules(.*[/\\])+mediasoup-client/,
            /node_modules(.*[/\\])+h264-profile-level-id/,
            /node_modules(.*[/\\])+awaitqueue/,
            /node_modules(.*[/\\])+semver/,
            /node_modules(.*[/\\])+engine.io-client/,
            /node_modules(.*[/\\])+socket.io/,
            /node_modules(.*[/\\])+@react-statel\/combobox/,
            /node_modules(.*[/\\])+parse5/,
            /node_modules(.*[/\\])+domhandler/,
            /node_modules(.*[/\\])+domutils/,
            /node_modules(.*[/\\])+htmlparser2/,
            /node_modules(.*[/\\])+cheerio/,
            /node_modules(.*[/\\])+rn-update-apk/,
            /node_modules(.*[/\\])+@craftzdog\/react-native-buffer/,
            /node_modules(.*[/\\])+buffer/,
            /node_modules(.*[/\\])+@react-aria/,
            /node_modules(.*[/\\])+@react-stately/,
            /node_modules(.*[/\\])+react-native-config/,
          ],
          use: 'babel-loader',
        },
        {
          test: /\.(js|jsx|ts|tsx|cjs)$/, 
          include: [
            /node_modules/,
            /node_modules(.*[/\\])+react-native/,
            /node_modules(.*[/\\])+axios/,
            /node_modules(.*[/\\])+react-native-gifted-chat/,
          ],
          use: 'babel-loader',
        },
        {
          test: /\.[jt]sx?$/,
          exclude: /node_modules/,
          use: {
            loader: 'babel-loader',
            options: {
              presets: ['module:metro-react-native-babel-preset'],
              /** Add React Refresh transform only when HMR is enabled. */
              plugins:
                devServer && devServer.hmr
                  ? ['module:react-refresh/babel']
                  : undefined,
            },
          },
        },
        {
          test: Repack.getAssetExtensionsRegExp(
            Repack.ASSET_EXTENSIONS.filter(ext => ext !== 'svg'),
          ),
          use: {
            loader: '@callstack/repack/assets-loader',
            options: {
              platform,
              inline: true,
              devServerEnabled: Boolean(devServer),
              scalableAssetExtensions: Repack.SCALABLE_ASSETS,
            },
          },
        },
        {
          test: /\.svg$/,
          use: [
            {
              loader: '@svgr/webpack',
              options: {
                native: true,
                dimensions: false,
              },
            },
          ],
        },
      ],
    },
    plugins: [
      new webpack.optimize.LimitChunkCountPlugin({
        maxChunks: 2
      }),
      new webpack.DefinePlugin({
        /**
         * appid
         */
        __APP_DEFINE_APPID__: `"${appid}"`,
        /**
         * app 版本号
         */
        __APP_DEFINE_VERSION__: `"${version}"`,
        /**
         * app 打包时间
         */
        __APP_DEFINE_BUILD_TIME__:`"${new Date().getTime()}"`,
      }),
      // new webpack.ids.HashedModuleIdsPlugin({
      //   context: path.join(`${dirname}`, `${appid}`, `${version}`, `${new Date().getTime()}`),
      //   hashFunction: 'sha256',
      //   hashDigest: 'hex',
      //   hashDigestLength: 20,
      // }),
      new Repack.RepackPlugin({
        context,
        mode,
        platform,
        devServer,
        output: {
          bundleFilename,
        },
      }),
      new Repack.plugins.ModuleFederationPlugin({
        name: `${appid}_v${version.replace(/\./gi, '_')}`,
        exposes: {
          './App': {
            import: exposesPath,
            name: appName
          },
        },
        shared: {
          ...sharedObj,
          react: {
            ...Repack.Federated.SHARED_REACT,
            requiredVersion: appSharedObj['react'].replace(/\^/gi, '')
          },
          'react-native': {
            ...Repack.Federated.SHARED_REACT_NATIVE,
            requiredVersion: appSharedObj['react-native'].replace(/\^/gi, '')
          },
        },
      }),
    ],
  }
}
